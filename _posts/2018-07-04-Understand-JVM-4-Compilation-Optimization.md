---
layout: post
title: 《深入理解Java虚拟机：JVM高级特性与最佳实践--第二版》学习日志（四）： 程序编译与代码优化
date: 2018-07-04 20:26:04
author: admin
comments: true
categories: [Java]
tags: [Java，JVM]
---

程序员对效率的追求，是永无停止的。

<!-- more -->
---

学习资料主要参考： 《深入理解Java虚拟机：JVM高级特性与最佳实践(第二版)》，作者：周志明

---
## 目录
{:.no_toc}

* 目录
{:toc}

---

# 早期（编译期）优化

## 1. 概述

Java的编译期，有很多意思：
- 可以是指前段编译器把 *.java 文件转为 *.class 文件的过程：Eclipse、Javac
- 可以是指虚拟机的后端运行期编译器（JIT编译器， just In time Compiler）把字节码转为机器码的过程：HotSpot VM的C1、C2编译器
- 也可能是指使用静态提前编译器（AOT，Ahead Of Time Compiler）直接把 *.java 文件编译成本地机器代码的过程：GNU Compiler for the java、excelsior JET

本章主要讨论第一类。

## 2. Javac 编译器

### 1）整体过程

从Sun Javac 的代码来看，编译过程大致可以分为3个过程：
1. 解析与填充符号表过程
2. 插入式注解处理器的注解处理过程
3. 分析与字节码生产过程

其中关键的处理由8个方法来完成，来看一看。

### 2）解析与填充符号表

#### 词法、语法分析
    
解析步骤由 parseFiles 方法完成。其中包括词法分析和语法分析两个过程。

词法分析是将字符流转为标记（Token）集合。

语法分析是根据token序列构造抽象语法树的过程。

#### 填充符号表

完成了词法分析和语法分析后，就是填充符号表了。由 enterTrees方法完成。

符号表是由一组符号地址和符号信息构成的表格。

符号表中所登记的信息在编译的不同阶段都要用到。在语义分析阶段，用于语义检查和产生中间代码。在目标代码生成阶段，符号表是对符号名进行地址分配的依据。

### 3）注解处理器

注解与普通的java代码一样，是在运行期间发挥作用的。

在JDK 1.6 中，提供了一组插入式注解处理器的标准API 在编译期间对注解进行处理。它们可以读取、修改、添加抽象语法树中的任意元素。如果修改了语法树，编译器将回到解析及填充符号表过程重新处理，直到所有插入式注解处理器都没有再对语法树进行修改为止，每一次的循环称为一个 Round。

### 4） 语义分析与字节码生成

语法树能够表示一个结构正确的源程序的抽象，但是无法保证源程序是符号逻辑的。这时候就需要语义分析了。包含标注检查和数据及控制流分析两个过程。

#### 标注检查

由attribute方法完成。

检查的内容包括诸如变量使用前是否已被声明、变量与赋值之间的数据类型是否能够匹配。

#### 数据及控制流分析

由flow方法完成。

这一步是对程序上下文逻辑更一步的验证，它可以检测出诸如程序局部吧在使用前是否有赋值、方法的每条路径是否都有返回值、是否所有的受查异常都被正确处理。

#### 解语法糖

使用语法糖能够增加程序的可读性，从而减少代码出错的机会。

比如泛型、变长参数、自动装箱/拆箱等。

#### 字节码生成

这个阶段，不仅仅是把起那么各个步骤所生成的信息转化为字节码写到磁盘上，编译器还进行了少了的代码添加和转换工作。

比如实例构造器 init 方法和类构造器 clinit 方法就是这个阶段添加到语法树之中的。


---

# 未完待续.....