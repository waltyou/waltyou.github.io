---
layout: post
title: 《深入理解Java虚拟机：JVM高级特性与最佳实践--第二版》学习日志（三）Part 3：虚拟机字节码执行引擎
date: 2018-06-16 10:26:04
author: admin
comments: true
categories: [Java]
tags: [Java，JVM]
---

虚拟机是如何执行字节码的呢？

<!-- more -->

---

学习资料主要参考： 《深入理解Java虚拟机：JVM高级特性与最佳实践(第二版)》，作者：周志明

---
## 目录
{:.no_toc}

* 目录
{:toc}

---

# 运行时栈帧结构

**栈帧**是用于支持虚拟机进行方法调用和方法执行的数据结构，它是虚拟机运行时数据区中虚拟机栈的栈元素。

栈帧存储了方法的局部变量表、操作数栈、动态连接和方法返回地址等信息。在编译程序代码时，栈帧需要多大的局部变量表、多深的操作数栈都已经确定。

每一个方法从调用开始到执行完成，都对应着一个栈帧在虚拟机栈里面入栈出栈的过程。

在活动线程中，只有位于栈顶的栈帧才是有效的，称为当前栈帧（Current Stack Frame），与这个栈帧相关联的方法称为当前方法（Current Method）。

下面介绍栈帧中各个部分的作用和数据结构。

## 1. 局部变量表

是一组变量值存储空间，用于存放方法参数和方法内部定义的局部变量。

局部变量表的容量以变量槽（Varable Slot）为最小单位。它可以存储一个boolean、byte、char、short、int、float、reference 或 returnAddress 类型的数据。其中 reference 表示对一个对象实例的引用。returnAddress类型已经很少见了，它为字节码jsr、jsr_w和ret服务。

虚拟机通过索引定位的方式使用局部变量表，索引值的范围是从0开始到局部变量表最大的Slot数量。

在方法执行时，虚拟机是使用局部变量表完成参数值到参数变量列表的传递过程的，如果执行的是实例方法，那局部变量表中的第0位索引的Slot默认是用于传递方法所属对象实例的引用，在方法可以用this来访问。

为了尽可能地节省栈帧空间，局部变量中的Slot是可以重用的，因为方法体中定义的变量都是由作用域的，当字节码PC计数器的值已经超出了某个变量的作用域时，这个变量对于的Slot就可以交给其他变量使用。

## 2. 操作数栈

也常称为操作栈。它是一个后入先出（Last In First Out，LIFO）栈。操作数栈的每一个元素可以是任意的Java数据类型，包括long和double。

当一个方法刚刚开始执行的时候，这个方法的操作数栈时空的，在方法的执行过程中，会有各种字节码指令往操作数栈中写入和提取内容，也就是入栈、出栈操作。

## 3. 动态连接

每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用，持有这个引用是为了支持方法调用过程中的动态连接（Dynamic Linking）。

Class文件的常量池中存有大量的符号引用，字节码中的方法调用指令就以常量池中指向方法的符号引用作为参数。这些符号引用，一部分会在类加载阶段或者第一次使用的时候转化为直接引用，这种称为静态解析。另外一部分将在每一次运行期间转化为直接引用，这部分称为动态连接。

## 4. 方法返回地址

当一个方法开始执行后，只有两种方式可以退出这个方法，第一种是执行引擎遇到任意一个方法返回的字节码指令。这种退出方法的方式称为**正常完成出口**。

另一种是在方法执行过程中遇到了异常，并且这个异常没有在方法体内处理。这种退出称为**异常完成出口**。

方法的退出过程实际上是当前栈帧的出栈。

## 5. 附加信息

虚拟机规范允许具体的虚拟机实现增加一些规范里没有描述的信息到栈帧之中。

在实际开发中，一般会把动态连接、方法返回地址和其他附加信息归为一类，称为栈帧信息。


---

# 未完待续.....