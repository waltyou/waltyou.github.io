---
layout: post
title: Java 并发编程实战-学习日志（三）3：并发程序的测试
date: 2019-12-10 18:01:04
author: admin
comments: true
categories: [Java]
tags: [Java, Concurrency, Java Concurrency In Practice]
---

<!-- more -->

---

* 目录
{:toc}
---

## 前言

在编写并发程序时，可以采用与写串行程序时相同的设计原则与设计模式。二者的差异在于，并发程序存在一定程度的不确定性。

并发测试大致可以分为两类：

- 安全性测试
- 活跃性测试
  - 进展测试
  - 无进展测试

与活跃性测试相关的是**性能测试**。性能可以通过多个方面来衡量，包括：

- 吞吐量
- 响应性
- 可伸缩性



## 正确性测试

在为某个并发类设计单元测试时，首先需要执行与测试串行类时相同的分析——找出需要检查的不变性条件和后验条件.

### 1. 基本的单元测试

这部分的测试代码与并发性没多大关系，用JUnit直接写测试代码就可以了。

### 2. 对阻塞操作的测试

如果在某个测试用例创建的辅助线程中发现了一个错误，那么框架通常无法得知与这个线程相关的是哪一个测试，所以需要通过一些工作将成功或失败信息传递回主线程，从而才能将相应的信息报告出来。

### 3. 安全性测试

编写的测试程序本身就是一个并发程序，测试在数据竞争条件下是否会发生错误。这就需要一个并发的测试程序。或许比编写本身要测试的类更加困难。

通过一个对顺序敏感的校验和计算函数来计算 所有入列的元素以及出列元素的检验和，并进行比较。如果二者相等，那么测试就是成功的。如果只有一个生产者一个消费者，那么 这种方法能发挥最大的作用。因为它不仅能测试出是否取出了正确的元素，而且还能测试出元素被取出的顺序是否正确。

如果要将这种方法扩展到多生产者多消费者的情况时，就需要一个对元素入列和出列顺序不敏感的校验和函数。从而在测试程序运行完以后，可以将多个检验和以不同的顺序组合起来，如果不是这样，多个线程就需要访问 同一个共享的检验和变量 ，因此就需要同步，这将成为一个并发的瓶颈。

要确保测试程序能够正确地测试所有要点，就一定不能让编译器可以预先猜测到检验 和的值。那么会对许多 其他 的测试造成影响。由于大多数随机类生成器都是线程安全的。并且会带来额外的同步开销。所以还不如用一个简单的伪随机函数 。

这种测试应该放在多处理器的系统上运行。要最大程序地检测出一些对执行时序敏感的数据竞争，那么测试中的线程数量应该多于CPU数量，这样在任意时刻都会有一些线程在运行，而另一些被交换出去，从而可以检查线程是交替行为的可预测性。










## 未完待续。。。。。。