---
layout: post
title: Java 并发编程实战-学习日志（三）2：性能与可伸缩性
date: 2019-10-30 18:01:04
author: admin
comments: true
categories: [Java]
tags: [Java, Concurrency, Java Concurrency In Practice]
---

线程的最主要目的是提高程序的运行性能，使程序更加充分地发挥系统的可用处理能力，从而提高系统的资源利用率，此外，还可以使程序在运行现有任务的情况下立即开始处理新的任务，从而提高系统的响应性。许多提升性能同样会增加复杂性，也会增加在安全性和活跃性上发生失败的风险。

<!-- more -->

---

* 目录
{:toc}
---

# 对性能的思考

对于一个给定的操作，通常会缺乏某种特定的资源，例如 CPU 时钟周期、内存、网络带宽、I/O 带宽。数据库请求、磁盘空间以及其他资源。当操作性能由于某种特定的资源而受到限制时，通常将该操作称为资源密集型的操作，例如，CPU 密集型、数据库密集型等。

通过并发来获得更好的性能：更有效地利用现有处理资源，以及在出现新的处理资源时使程序尽可能地利用这些新资源。从性能监视的视角看，CPU 需要尽可能保持忙碌状态。

## 1. 性能与可伸缩性

应用程序的性能可以采用多个指标来衡量，例如服务时间、延迟时间、吞吐率、效率、可伸缩性以及容量等。其中一些指标（服务时间、等待时间）用于衡量程序的 "运行速度"，即某个指定的任务单元需要 "多快" 才能处理完成。另一些指标（生产量、吞吐量）用于程序的 "处理能力"，即在计算资源一定的情况下，能完成 "多少" 工作。

可伸缩性指的是：当增加计算资源时（例如 CPU、内存、存储容量或 I/O 带宽），程序的吞吐量或者处理能力能相应地增加。

## 2. 评估各种性能权衡因素：

在几乎所有的工程决策中都会涉及某些形式的权衡。在作出正确的权衡时通常会缺少相应的信息，例如，"快速排序" 算法在大规模数据集上的执行效率非常高，但对于小规模的数据集，"冒泡排序" 实际上更高效。要实现一个高效的排序算法，那么需要知道被处理数据集的大小，还有衡量优化的指标，包括：平均计算时间、最差时间、可预知性等。大多数优化措施都不成熟的原因之一是通常无法获得一组明确的需求。

进行决策时，会通过增加某种形式的成本来降低另一种形式的开销（例如，增加内存使用量以降低服务时间），也会通过增加开销来换取安全性。很多性能优化措施通常都是以牺牲可读性或可维护性，或会破坏面向对象的设计原则，例如需要打破封装，或带来更高的错误风险，因为通常越快的算法就越复杂。

对性能的提升可能使并发错误的最大来源，例如采用双重检查锁来减少同步的使用，由于并发错误是最难追踪和消除的错误，因此对于任何可能会引入这类错误的措施，都需要谨慎实施。

对性能调优时，一定要有明确的性能需求（才能知道什么时候需要调优，以及什么时候应该停止），此外还需要一个测试程序以及真实的配置和负载等环境。在对性能调优后，需要再次测量以验证是否到达了预期的性能提升目标。在许多优化措施中带来的安全性和可维护性等风险非常高。免费的 perfbar 应用程序可以给出 CPU 的忙碌程度信息，而通常目标就是使 CPU 保持忙碌状态，因此可以有效地评估是否需要进行性能调优或者已实现的调优效果如何。



#  Amdahl 定律

如果可用资源越多，那么问题的解决速度就越快，例如，如果参与收割庄稼的工人越多，那么就能越快地完成工作。而有些任务本质上是串行的，例如，即使增加再多的工人也不可能增加作物的生长速度。如果使用线程主要是为了发挥多个处理器的处理能力，那么就必须对问题进行合理的并行分解，并使得程序能有效地使用这种潜在的并行能力。

​    大多数并发程序都是由一系列的并行工作和串行工作组成。Amdahl 定律描述的：在增加计算资源的情况下，程序在理论上能够实现最高加速比，这个值取决于程序中可并行组件与串行组件所占比重。假定 F 是必须被串行执行的部分，根据 Amdahl 定律，在包含 N 个处理器的机器中，最高的加速比：

​    **Speedup <= 1 /  (F + (1-F) / N)**

当 N 趋近于无穷大时，最大的加速比趋近于 1/F。因此，如果程序有 50% 的计算需要串行执行，那么最高的加速比只能是 2（不管有多少个线程可用）；如果在初中有 10% 的计算需要串行执行，那么最高的加速比将接近 10。Amdahl 定律还量化了串行化的效率开销。在拥有 10 个处理器的系统中，如果程序中有 10% 的部分需要串行化执行，那么最高的加速比为 5.3（53%的使用率），在拥有 100 个处理器的系统中，加速比可达到 9.2（9%的使用率）。即使拥有无限多的 CPU，加速比也不可能为 10。随着处理器的增加，即使串行部分所占的百分比很小，也会极大地限制当增加计算资源时能够提升的吞吐率。




[![](/images/posts/java-Amdahl.gif)](/images/posts/java-Amdahl.gif) 











## 未完待续。。。